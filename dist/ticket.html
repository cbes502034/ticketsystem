<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ¼”å”±æœƒåº§ä½åœ–</title>
  <style>
    body { background: white; text-align: center; font-family: sans-serif; }
    .stage { width: 761px; height: 40px; background: black; color: white; line-height: 40px; margin: 20px auto; font-weight: bold; }

    .seating-area { display: flex; flex-direction: column; align-items: center; gap: 5px; }
    .row { display: flex; justify-content: center; gap: 0; }
    .seat { width: 15px; height: 15px; margin: 1px; border: 1px solid black; cursor: pointer; }
    .rock { background-color: red; }
    .a { background-color: yellow; }
    .b, .c { background-color: orange; }
    .d { background-color: pink; }

    .selected { background-color: gray !important; }
    .sold { background-color: #999 !important; }
    .section-wrapper { display: flex; justify-content: center; gap: 5px; }
    #confirm-btn { margin-top: 10px; cursor: pointer; }

    .seating-area.loading { opacity: .6; }
    .seating-area.loading .seat { pointer-events: none; }

    dialog#ticket-modal { border: none; border-radius: 10px; box-shadow: 0 0 16px rgba(0,0,0,.25); padding: 0; width: 360px; }
    .modal-header { position: relative; padding: 14px 16px; border-bottom: 4px solid #222; }
    .modal-title { font-weight: 700; }
    .modal-close { position: absolute; top: 8px; right: 8px; border: 2px solid #000; background: #fff; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-weight: 900; }
    .modal-body { padding: 18px 20px 8px; text-align: left; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
    td { padding: 4px 0; }
    .caption { color: #666; margin: 6px 0 10px; }
    .countdown { text-align: center; font-weight: bold; color: #d9534f; }
    .form-row { margin: 10px 0; }
    #totp-input { width: 100%; font-size: 16px; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; }
    .modal-actions { display: flex; justify-content: space-between; padding: 12px 20px 20px; gap: 12px; }
    .btn { flex: 1 1 0; padding: 10px 0; border: 2px solid #000; border-radius: 6px; background: #fff; cursor: pointer; font-weight: 700; }
    .btn-primary { background: #007bff; color: #fff; border-color: #007bff; }
    .btn-danger  { background: #fff; color: #000; }
  </style>
</head>
<body>

  <div class="stage">STAGE</div>

  <div id="seatingArea" class="seating-area loading">
    <div class="section-wrapper">
      <div id="rock-left"></div>
      <div id="rock-center"></div>
      <div id="rock-right"></div>
    </div>
    <div class="section-wrapper">
      <div id="b-area"></div>
      <div id="a-area"></div>
      <div id="c-area"></div>
    </div>
    <div class="section-wrapper">
      <div style="width: 165px;"></div>
      <div id="d-area"></div>
      <div style="width: 165px;"></div>
    </div>

    <p id="info" style="color: red; font-weight: bold;">è¼‰å…¥åº§ä½è³‡æ–™ä¸­â€¦</p>
    <button id="confirm-btn" disabled>ç¢ºå®š</button>
  </div>

  <dialog id="ticket-modal">
    <div class="modal-header">
      <div class="modal-title">å€’æ•¸</div>
      <button id="modal-close" class="modal-close" aria-label="é—œé–‰">Ã—</button>
      <div id="countdown" class="countdown"></div>
    </div>
    <div class="modal-body">
      <table id="ticket-table"></table>
      <div class="caption">è³¼ç¥¨ç¨‹åºâ€¦</div>
      <div class="form-row">
        <label for="totp-input"><strong>totp é©—è­‰ç¢¼</strong></label>
        <input id="totp-input" type="text" placeholder="è«‹è¼¸å…¥é©—è­‰ç¢¼" inputmode="numeric" />
      </div>
    </div>
    <div class="modal-actions">
      <button id="btn-submit" class="btn btn-primary">ç¢ºå®š</button>
      <button id="btn-abandon" class="btn btn-danger">æ”¾æ£„</button>
    </div>
  </dialog>

  <script>
    // ---------- å…¨åŸŸç‹€æ…‹ ----------
    let eventTitle = null;
    let eventID = null;
    let area = null, row = null, column = null, selectedSeat = null;

    let appReady = false;
    let lockActive = false;
    let lockDeadlineMs = null;
    let rafId = null;
    let serverClientOffsetMs = 0;

    const areaMap = {
      "rock-left":"æ–æ»¾å€å·¦","rock-center":"æ–æ»¾å€ä¸­","rock-right":"æ–æ»¾å€å³",
      "a-area":"Aå€","b-area":"Bå€","c-area":"Cå€","d-area":"Då€"
    };
    const toCN = (v) => areaMap[v] || v;
    const normArea = (x) => toCN(String(x)).trim();

    const modal = document.getElementById("ticket-modal");
    const countdownEl = document.getElementById("countdown");
    const ticketTable = document.getElementById("ticket-table");
    const infoEl = document.getElementById("info");
    const seatingArea = document.getElementById("seatingArea");
    const confirmBtn = document.getElementById("confirm-btn");

    const normalizeEventId = (obj) => obj?.event_id ?? obj?.eventID ?? obj?.id ?? null;

    // ---------- ç”¢ç”Ÿåº§ä½ ----------
    function generateSeats(containerId, rows, cols, className) {
      const container = document.getElementById(containerId);
      for (let r = 0; r < rows; r++) {
        const rowDiv = document.createElement("div"); rowDiv.className = "row";
        for (let c = 0; c < cols; c++) {
          const seat = document.createElement("button");
          seat.className = `seat ${className}`;
          seat.dataset.original = className;
          seat.dataset.area = containerId;
          seat.dataset.row = r + 1;
          seat.dataset.col = c + 1;
          seat.title = `${areaMap[containerId] || containerId} ${r + 1}æ’ ${c + 1}ä½`;
          seat.disabled = true;
          rowDiv.appendChild(seat);
        }
        container.appendChild(rowDiv);
      }
    }
    generateSeats("rock-left", 5, 10, "rock");
    generateSeats("rock-center", 5, 20, "rock");
    generateSeats("rock-right", 5, 10, "rock");
    generateSeats("b-area", 20, 10, "b");
    generateSeats("a-area", 20, 20, "a");
    generateSeats("c-area", 20, 10, "c");
    generateSeats("d-area", 10, 20, "d");

    // ---------- æ™‚é–“å·¥å…· ----------
    function serverNowFromHeaders(headers) {
      try { const d = headers?.get?.('Date'); const t = d ? Date.parse(d) : NaN; return Number.isFinite(t) ? t : null; }
      catch { return null; }
    }
    function deriveDeadlineMsFromTTLSeconds(ttlSeconds, headers) {
      const clientNow = Date.now();
      const srv = serverNowFromHeaders(headers) ?? clientNow;
      return (typeof ttlSeconds === 'number' && ttlSeconds >= 0) ? (srv + ttlSeconds * 1000) : null;
    }
    const adjustedNowMs = () => Date.now() + serverClientOffsetMs;

    // ---------- å€’æ•¸ ----------
    function startCountdownLoop() {
      stopCountdownLoop();
      function tick() {
        const remainMs = Math.max(0, (lockDeadlineMs ?? 0) - adjustedNowMs());
        const sec = Math.floor(remainMs / 1000);
        const ms  = remainMs % 1000;
        const text = `é–å®šå‰©é¤˜ï¼š${sec}.${String(ms).padStart(3, "0")} ç§’`;
        if (modal.open) countdownEl.textContent = text;
        if (remainMs <= 0) {
          lockActive = false; lockDeadlineMs = null;
          stopCountdownLoop();
          if (modal.open) modal.close();
          alert("é–å®šæ™‚é–“å·²åˆ°ï¼Œåº§ä½å·²é‡‹æ”¾ã€‚è«‹é‡æ–°é¸æ“‡ã€‚");
          if (selectedSeat) selectedSeat.classList.remove("selected");
          selectedSeat = null;
          infoEl.textContent = "å°šæœªé¸æ“‡ä»»ä½•åº§ä½";
          return;
        }
        rafId = requestAnimationFrame(tick);
      }
      rafId = requestAnimationFrame(tick);
    }
    function stopCountdownLoop() {
      if (rafId != null) cancelAnimationFrame(rafId);
      rafId = null;
      countdownEl.textContent = "";
    }

    // ---------- é» seat ----------
    document.addEventListener("click", async (e) => {
      if (!e.target.classList.contains("seat")) return;
      if (!appReady) return;
      if (e.target.disabled) return;

      if (selectedSeat) selectedSeat.classList.remove("selected");
      e.target.classList.add("selected"); selectedSeat = e.target;

      area   = normArea(e.target.dataset.area);
      row    = e.target.dataset.row;
      column = e.target.dataset.col;
      infoEl.textContent = `${area} ${row}æ’ ${column}ä½`;

      if (!eventID) return;

      try {
        const res = await fetch("/ticket/check", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ event_id: eventID })
        });
        const payload = await res.json();
        if (payload?.status === false && payload?.notify) {
          alert(payload.notify);
          e.target.classList.remove("selected");
          selectedSeat = null;
          infoEl.textContent = "å°šæœªé¸æ“‡ä»»ä½•åº§ä½";
          return;
        }
      } catch (err) {
        console.error("ticket/check å¤±æ•—", err);
        alert("æª¢æŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        e.target.classList.remove("selected");
        selectedSeat = null;
        infoEl.textContent = "å°šæœªé¸æ“‡ä»»ä½•åº§ä½";
      }
    });

    // ---------- ä¸»æŒ‰éˆ•ã€Œç¢ºå®šã€ ----------
    confirmBtn.addEventListener("click", async () => {
      if (!appReady) return;
      if (!selectedSeat) { alert("è«‹å…ˆé¸æ“‡ä¸€å€‹åº§ä½ï¼"); return; }

      if (lockActive && lockDeadlineMs && adjustedNowMs() < lockDeadlineMs) {
        renderTicketTable();
        modal.showModal();
        return;
      }

      const ticketData = { area, row, column, event_id: eventID };
      await tryLockAndOpen(ticketData);
    });

    async function tryLockAndOpen(ticketData) {
      try {
        const res = await fetch("/ticket/lock", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(ticketData)
        });
        const payload = await res.json();

        if (payload?.status !== true) {
          alert(payload?.notify || "é–å®šå¤±æ•—");

          // ğŸš« ç‰¹åˆ¥è™•ç†ã€Œä¸å¯å¤šé¸ã€
          if (payload?.notify?.includes("ä¸å¯å¤šé¸")) {
            if (selectedSeat) {
              selectedSeat.classList.remove("selected");
              selectedSeat = null;
            }
            infoEl.textContent = "æ‚¨å·²ç¶“åœ¨å…¶ä»–æ´»å‹•é–ç¥¨ï¼Œè«‹å…ˆå®Œæˆæˆ–æ”¾æ£„å†è©¦ã€‚";
          }

          return false;
        }

        // âœ… æ­£å¸¸é–å®šæˆåŠŸ
        const srv = serverNowFromHeaders(res.headers) ?? Date.now();
        serverClientOffsetMs = srv - Date.now();

        lockActive = true;
        lockDeadlineMs = deriveDeadlineMsFromTTLSeconds(Number(payload.time), res.headers);

        renderTicketTable();
        ensureSeatSelectedInUI(ticketData);
        modal.showModal();
        if (lockDeadlineMs) startCountdownLoop();
        document.getElementById("totp-input").focus();
        return true;
      } catch (err) {
        console.error(err);
        alert("é–å®šè«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        return false;
      }
    }

    function ensureSeatSelectedInUI({ area: areaCN, row: r, column: c }, opts = {}) {
      areaCN = normArea(areaCN);
      const domId = Object.keys(areaMap).find(k => areaMap[k] === areaCN) || null;
      if (!domId) return;
      const container = document.getElementById(domId);
      if (!container) return;

      if (selectedSeat) selectedSeat.classList.remove("selected");

      const rowIdx = Number(r) - 1;
      const colIdx = Number(c) - 1;
      const rowDiv = container.children[rowIdx];
      if (!rowDiv) return;
      const seatBtn = rowDiv.children[colIdx];
      if (!seatBtn) return;

      if (seatBtn.disabled && !opts.allowDisabledSelect) return;

      seatBtn.classList.add("selected");
      selectedSeat = seatBtn;

      area = areaCN; row = String(r); column = String(c);
      infoEl.textContent = `${area} ${row}æ’ ${column}ä½`;
    }

    function renderTicketTable() {
      ticketTable.innerHTML = `
        <tr><td>æ¼”å”±æœƒå ´æ¬¡ï¼š</td><td>${eventTitle ?? ""}</td></tr>
        <tr><td>å€åŸŸï¼š</td><td>${area ?? ""}</td></tr>
        <tr><td>ä½ç½®ï¼š</td><td>${row ?? ""}æ’${column ?? ""}ä½</td></tr>
      `;
    }

    // ---------- å°è©±æ¡†æ§åˆ¶ ----------
    document.getElementById("modal-close").addEventListener("click", onCancelClicked);
    document.getElementById("btn-abandon").addEventListener("click", onCancelClicked);
    async function onCancelClicked() {
      const ok = await surrenderLock({ event_id: eventID, area, row, column });
      if (ok) {
        lockActive = false;
        lockDeadlineMs = null;
        stopCountdownLoop();
        if (selectedSeat) { selectedSeat.classList.remove("selected"); selectedSeat = null; }
        infoEl.textContent = "å·²æ”¾æ£„æœ¬æ¬¡é–å®š";
      } else {
        console.warn("å–æ¶ˆé–å®šå¤±æ•—æˆ–æœªå¯¦ä½œ API");
      }
      modal.close();
    }

    document.getElementById("btn-submit").addEventListener("click", submitTotp);
    async function submitTotp() {
      if (!lockActive || !lockDeadlineMs || adjustedNowMs() >= lockDeadlineMs) {
        alert("é–å®šå·²å¤±æ•ˆï¼Œè«‹é‡æ–°é¸æ“‡åº§ä½ã€‚");
        if (modal.open) modal.close();
        return;
      }
      const totp = document.getElementById("totp-input").value.trim();
      if (!totp) { alert("è«‹è¼¸å…¥é©—è­‰ç¢¼ã€‚"); return; }

      const ticketData = { area, row, column, totpcode_input: totp, event_id: eventID };
      try {
        const res = await fetch("/ticket", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(ticketData)
        });
        const payload = await res.json();
        if (payload.status) {
          alert("è³¼ç¥¨æˆåŠŸï¼");
          modal.close();
          window.location.href = "ticket_success.html";
        } else {
          console.log(payload);
          alert(payload.notify || "è³¼ç¥¨å¤±æ•—");
        }
      } catch (err) {
        console.error(err);
        alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    }

    async function surrenderLock(payload) {
      try {
        const resp = await fetch("/ticket/cancel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        return (data?.status ?? data?.response?.status) === true;
      } catch (err) {
        console.error("surrenderLock error:", err);
        return false;
      }
    }

    // ---------- å–å¾—å·²è³¼æ¸…å–®ï¼Œåç° ----------
    async function GetTicketAvailability() {
      const fail = () => {
        infoEl.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚";
      };

      try {
        const res = await fetch("/ticket/availability", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: eventTitle })
        });
        const response = await res.json();
        console.log(response);

        eventID = response.event_id ?? response.eventID ?? response.id ?? eventID;

        const purchased = response.purchased || [];
        document.querySelectorAll(".seat").forEach(seat => {
          const areaKey = normArea(seat.dataset.area);
          const r = parseInt(seat.dataset.row, 10);
          const c = parseInt(seat.dataset.col, 10);
          const isPurchased = purchased.some(([dbArea, dbRow, dbCol]) =>
            normArea(dbArea) === areaKey && Number(dbRow) === r && Number(dbCol) === c
          );
          if (isPurchased) {
            seat.classList.add("sold");
            seat.disabled = true;
          }
        });

        await tryRestoreFromAPI();

        seatingArea.classList.remove("loading");
        infoEl.textContent = "è«‹é¸æ“‡åº§ä½";
        confirmBtn.disabled = false;
        document.querySelectorAll(".seat").forEach(seat => {
          seat.disabled = seat.classList.contains("sold");
        });
        appReady = true;
      } catch (err) {
        console.error(err);
        fail();
      }
    }

    function isBenignRestoreMiss(payload) {
      const msg = (payload?.notify || "").toString();
      return (
        msg.includes("æ²’æœ‰é¸ä½") ||
        msg.includes("ä¸å•Ÿå‹•è‡ªå‹•é¡¯ç¤ºè³¼è²·ç•«é¢") ||
        msg.toLowerCase().includes("no seat")
      );
    }

    async function tryRestoreFromAPI() {
      try {
        const res = await fetch("/ticket/restore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        const payload = await res.json();
        console.log("[restore] payload =", payload);

        const srv = serverNowFromHeaders(res.headers) ?? Date.now();
        serverClientOffsetMs = srv - Date.now();

        if (payload?.status === true) {
          const s = payload.seat || payload;
          const restoredId = normalizeEventId(s);

          if (restoredId == null) {
            console.warn("[restore] å›å‚³æ²’æœ‰ event_idï¼Œè·³éæ¢å¾©");
            return;
          }
          if (eventID && String(eventID) !== String(restoredId)) {
            console.warn("[restore] event_id ä¸ä¸€è‡´ï¼Œé é¢ =", eventID, "æ¢å¾©åŒ… =", restoredId, "â†’ è·³é");
            return;
          }
          eventID = String(restoredId);

          area   = normArea(s.area);
          row    = String(s.row);
          column = String(s.column);

          ensureSeatSelectedInUI({ area, row, column }, { allowDisabledSelect: true });

          lockActive = true;
          lockDeadlineMs = deriveDeadlineMsFromTTLSeconds(Number(payload.time), res.headers);

          renderTicketTable();
          modal.showModal();
          if (lockDeadlineMs) startCountdownLoop();
          document.getElementById("totp-input").focus();

        } else if (payload?.status === false) {
          if (!isBenignRestoreMiss(payload)) {
            alert(payload.notify || "æ¢å¾©å¤±æ•—");
          }
        }
      } catch (err) {
        console.error("ticket/restore å¤±æ•—", err);
      }
    }

    function setStageTitleFromURL() {
      const params = new URLSearchParams(window.location.search);
      eventTitle = decodeURIComponent(params.get("title") || "STAGE");
      document.querySelector(".stage").textContent = eventTitle;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      setStageTitleFromURL();
      await GetTicketAvailability();
    });
  </script>
</body>
</html>
